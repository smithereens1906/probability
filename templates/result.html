{% extends "base.html" %}
{% block extra %}
  <script>
    const evtSource = new EventSource("{{ url_for('progress_sse', job_id=job_id) }}");
    evtSource.onmessage = function(e){
      const d = JSON.parse(e.data);
      const pct = Math.round(100 * d.done / d.total);
      document.querySelector(".progress-bar").style.width = pct + "%";
      document.querySelector(".progress-bar").textContent = pct + "%";
      if(d.done >= d.total) location.reload();
    };
  </script>
{% endblock %}

{% block content %}
{% if not finished %}
  <h4>Running simulation…</h4>
  <div class="progress my-3" style="height:25px">
    <div class="progress-bar" role="progressbar" style="width:0%">0%</div>
  </div>
{% else %}
  <div class="row">
    <div class="col-lg-6">
      <h4>Probability heat-map</h4>
      <img src="data:image/png;base64,{{ img }}" class="heatmap">
    </div>
    <div class="col-lg-6">
      <h4>Summary statistics</h4>
      <ul class="list-group mb-3">
        <li class="list-group-item">Mean probability: <b>{{ "%.6f"|format(stats.mean) }}</b></li>
        <li class="list-group-item">Highest: <b>{{ "%.6f"|format(stats.max) }}</b> at row {{ stats.max_pos[0] }}, col {{ stats.max_pos[1] }}</li>
        <li class="list-group-item">Lowest: <b>{{ "%.6f"|format(stats.min) }}</b> at row {{ stats.min_pos[0] }}, col {{ stats.min_pos[1] }}</li>
      </ul>
      <a class="btn btn-success btn-sm" href="{{ url_for('download', job_id=job_id) }}">⬇ Download CSV</a>
      <a class="btn btn-outline-primary btn-sm" href="{{ url_for('index') }}">New simulation</a>
    </div>
  </div>
  <details class="mt-4">
    <summary>View numeric matrix</summary>
    {{ tables|safe }}
  </details>
{% endif %}
{% endblock %}